name: Docker Scan Lab with Syft + Grype (Always Green)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Set up Docker
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      # 3️⃣ Build Docker image
      - name: Build Docker image
        run: docker build -t demo-app .

      # 4️⃣ Install Syft and Grype
      - name: Install Syft and Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh
          syft --version
          grype --version

      # 5️⃣ Generate SBOM (always succeeds)
      - name: Generate SBOM
        run: syft docker:demo-app -o spdx-json > sbom.json || true

      # 6️⃣ Scan vulnerabilities (always succeeds)
      - name: Scan Docker image for vulnerabilities
        id: grype_scan
        run: |
          # Run Grype and force success
          grype docker:demo-app -o json > grype-report.json || true
          
          # Check for CRITICAL vulnerabilities
          if grep -q '"severity": "Critical"' grype-report.json 2>/dev/null; then
            echo "Vulnerability detected" | tee grype-report.txt
            echo "true" >> result.tmp
          else
            echo "No vulnerability detected" | tee grype-report.txt
            echo "false" >> result.tmp
          fi

          # Set GitHub Actions env variable
          echo "vuln=$(cat result.tmp)" >> $GITHUB_ENV

      # 7️⃣ Sign SBOM (simulation)
      - name: Sign SBOM
        run: echo "signed" > sbom.sig

      # 8️⃣ Display final log
      - name: Display vulnerability result
        run: |
          if [ "$vuln" = "true" ]; then
            echo "❌ Critical vulnerability detected!"
          else
            echo "✅ No critical vulnerability detected!"
          fi
