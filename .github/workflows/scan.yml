name: Docker Scan Lab with Syft + Grype

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Récupérer le code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Configurer Docker
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      # 3️⃣ Construire l'image Docker
      - name: Build Docker image
        run: docker build -t demo-app .

      # 4️⃣ Installer Syft et Grype
      - name: Install Syft and Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh
          syft --version
          grype --version

      # 5️⃣ Générer SBOM avec Syft
      - name: Generate SBOM
        run: syft docker:demo-app -o spdx-json > sbom.json || true

      # 6️⃣ Scanner vulnérabilités avec Grype
      - name: Scan Docker image for vulnerabilities
        id: grype_scan
        run: |
          grype docker:demo-app -o json > grype-report.json || true
          
          # Vérifier vulnérabilité CRITICAL
          if grep -q '"severity": "Critical"' grype-report.json 2>/dev/null; then
            echo "Vulnerability detected" | tee grype-report.txt
            echo "true" >> result.tmp
          else
            echo "No vulnerability detected" | tee grype-report.txt
            echo "false" >> result.tmp
          fi

          # Stocker le résultat pour GitHub Actions
          echo "vuln=$(cat result.tmp)" >> $GITHUB_ENV

      # 7️⃣ Signer SBOM (simulation)
      - name: Sign SBOM
        run: echo "signed" > sbom.sig

      # 8️⃣ Afficher log pédagogique
      - name: Display vulnerability result
        run: |
          if [ "$vuln" = "true" ]; then
            echo "❌ Critical vulnerability detected!"
          else
            echo "✅ No critical vulnerability detected!"
          fi
