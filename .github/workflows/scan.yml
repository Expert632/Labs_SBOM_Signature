name: Docker Scan Lab Always Green

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Set up Docker
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      # 3️⃣ Build Docker image
      - name: Build Docker image
        run: docker build -t demo-app . || true

      # 4️⃣ Install Syft and Grype globally
      - name: Install Syft and Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh || true
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh || true
          sudo mv ./bin/syft /usr/local/bin/syft || true
          sudo mv ./bin/grype /usr/local/bin/grype || true
          syft --version || true
          grype --version || true

      # 5️⃣ Generate SBOM (always succeeds)
      - name: Generate SBOM
        run: syft docker:demo-app -o spdx-json > sbom.json || true

      # 6️⃣ Scan Docker image for vulnerabilities (always succeeds)
      - name: Scan Docker image
        id: scan
        run: |
          grype docker:demo-app -o json > grype-report.json || true

          # Create TXT report
          if grep -q '"severity": "Critical"' grype-report.json 2>/dev/null; then
            echo "Vulnerability detected" | tee grype-report.txt
            echo "true" > vuln.tmp
          else
            echo "No vulnerability detected" | tee grype-report.txt
            echo "false" > vuln.tmp
          fi

          # Export variable for later steps
          echo "vuln=$(cat vuln.tmp)" >> $GITHUB_ENV

      # 7️⃣ Sign SBOM (simulation, always succeeds)
      - name: Sign SBOM
        run: echo "signed" > sbom.sig || true

      # 8️⃣ Display final log pedagogical
      - name: Display vulnerability result
        run: |
          if [ "$vuln" = "true" ]; then
            echo "❌ Critical vulnerability detected!"
          else
            echo "✅ No critical vulnerability detected!"
          fi
