name: Security Gate Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  security-gate:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Set up Docker
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      # 3️⃣ Build Docker image
      - name: Build Docker image
        run: docker build -t demo-app .

      # 4️⃣ Install Syft and Grype globally
      - name: Install Syft and Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh
          sudo mv ./bin/syft /usr/local/bin/syft
          sudo mv ./bin/grype /usr/local/bin/grype
          syft --version
          grype --version

      # 5️⃣ Generate SBOM
      - name: Generate SBOM
        run: syft docker:demo-app -o spdx-json > sbom.json

      # 6️⃣ Scan vulnerabilities
      - name: Scan Docker image for vulnerabilities
        id: scan
        run: |
          grype docker:demo-app -o json > grype-report.json

          # Create TXT report
          if grep -q '"severity": "Critical"' grype-report.json 2>/dev/null; then
            echo "Vulnerability detected" | tee grype-report.txt
            echo "true" > vuln.tmp
          else
            echo "No vulnerability detected" | tee grype-report.txt
            echo "false" > vuln.tmp
          fi

          # Export variable for later steps
          echo "vuln=$(cat vuln.tmp)" >> $GITHUB_ENV

      # 7️⃣ Display result and fail job if critical vulnerability detected
      - name: Security gate check
        run: |
          if [ "$vuln" = "true" ]; then
            echo "❌ Critical vulnerability detected! Failing the job."
            exit 1
          else
            echo "✅ No critical vulnerability detected. Job passes."
          fi
